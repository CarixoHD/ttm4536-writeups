#include <openssl/conf.h>
#include <openssl/evp.h>
#include <openssl/err.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>
#include <fcntl.h>
#include <stdint.h>
#include <stddef.h>
#include <sys/mman.h>

// dependencies: openssl

unsigned char* ciphertext = (unsigned char *)"\xcd\xc4\x4c\x11\xe7\x9f\xac\xab\x9e\x1d\x50\x43\xc8\x17\x5f\x86\x7a\xe9\x39\xfd\x5f\x36\xb1\x51\x66\x12\x97\x76\x6f\x57\xee\xe7\x53\xce\xef\x02\x9e\x25\x81\x96\x85\x5f\x52\x56\xfa\x6f\x1c\xb8\x52\x5d\xb8\x6b\x7d\x34\x5a\xcd\x6a\x41\x63\x28\x05\xee\x22\x90\x4c\xf5\xaa\x19\x5e\x9e\xec\xd5\x2b\xf2\x10\x0e\x70\x6d\x71\xbe\xdc\xb1\x83\x02\x4f\x2e\xe1\xf8\xde\xfa\xdc\x07\xc3\x0f\x82\x6e\x47\xcf\xfd\xcb\xab\x6e\x76\xf5\x34\x4f\x32\x5b\xcb\xfd\x47\xb8\x33\xc8\x16\xeb\x1d\xc3\x7b\xcb\xf4\x39\xdf\x70\x6c\xca\x92\x01\x4a\x86\x8f\x43\x8a\x43\x19\x6e\x77\xf2\xb8\x96\xa3\xce\x1a\x5f\xad\xc7\x8f\xea\xe8\x6f\xaa\x89\x84\x5f\x67\xb7\x95\xc8\x0a\x1c\xdb\x61\x53\xc6\xc8\x0c\xe3\xcb\xf5\x08\xc0\xf3\xea\x0f\x3b\x2d\xcb\x3e\x9e\x57\x29\x70\xf6\x7d\x70\xc4\xd2\x2b\x9f\xe9\xd9\x6e\x5f\x93\x20\x69\xd5\xf4\x2e\x5c\xd6\x60\x86\xa4\x2d\x61\xac\xe6\x4c\xe1\x9a\xa7\x18\x97\x09\x3a\x19\x65\x08\x80\xf9\x13\x0a\xe6\x0f\x4e\x55\x34\xe6\x35\x6b\xba\xa3\x82\x21\x4c\xff\xc2\xf7\xc7\x02\x95\xf3\x70\x25\xb7\x9b\xc8\x3e\x20\x5b\x7c\xd4\x83\x3d\x48\x72\x22\x69\xf7\x6e\xd3\x9b\x42\x06\x7a\xbd\x58\x4f\x16\x0e\x7b\x6d\x4b\x03\x12\x94\x1d\xad\x0e\xb1\x3d\x36\x93\xde\x79\x39\x26\x46\xeb\xe8\x2e\x94\x50\xc7\xd7\x4c\x4d\x9c\x54\xf6\xa4\x8a\x18\x47\xe2\xe3\x4f\xcd\x5d\x52\x77\x85\x2e\x20\x13\x0f\xaf\x43\xd3\x4d\x4b\x8a\xaa\x9b\x7e\x7b\x6a\x9e\x43\x5b\x07\xac\x22\x80\x71\x2b\xfc\x0c\x7e\x07\x88\xa4\xaa\x7e\xbd\xbe\x09\x5b\xdd\xba\x69\xd3\xf4\xd7\xf1\xdc\xc8\xfe\xf4\xcd\x47\xc8\x9a\x20\xee\xf8\xa0\xa1\x66\x50\x1f\x64\xb3\x32\x89\x79\xa6\x3b\xb4\x29\x44\x9c\x2c\x90\x57\x6e\xa4\xf3\xb4\xda\xa7\x49\x35\x84\xb5\xb6\x08\x75\xdb\x4d\x2a\x7f\x2d\xd9\xa0\x0e\x70\xdd\x35\xb2\x5b\xf6\xce\xb7\x33\xe2\x8a\xbc\x62\x7d\xee\x61\xb1\xe1\xff\xb5\x57\x2c\xe8\xfe\xa0\xb0\x22\x40\x61\x44\x19\x55\x8a\xa0\xfe\x78\x95\x51\x84\x52\x50\x32\x9b\xf1\x04\x4e\xd2\x79\x62\xe6\xf3\x7d\x1f\x03\x20\x8d\xf3\xfa\x9e\x52\xe6\x50\x18\xe7\x64\xf1\x45\x9d\xfd\xa4\x13\x4f\xa9\x8f\x8e\x3d\x58\x94\x85\x4d\xf3\x44\x11\xbe\xdb\xfa\x1f\xd0\x9d\x4e\xf5\xa0\x2b\xde\x52\x31\x28\x38\x2a\xb9\xde\x8f\x0d\xc4\x29\x29\x54\xb8\x34\x02\x8d\x96\xe9\xd5\x1d\x01\x04\xaf\x48\x4f\x21\x0c\x96\x26\x83\xdc\xcc\x18\x28\x26\x99\x51\xfa\x43\x06\x74\xd9\xc0\x06\x21\x95\xe7\x6b\x83\x53\x64\x57\x3f\xce\x2c\x2a\x62\x4e\x28\x30\xb7\x80\x5f\x8c\xbd\x6a\x71\x7f\xe7\x6b\xdb\x3a\x68\x2c\x8c\x8c\xa2\xd9\xa9\x46\x16\x89\xdf\x95\x1c\x67\xc7\x6a\x3f\xf6\x2d\x62\xf2\x77\xa2\xf0\xb4\xf5\xfb\xf7\xda\x54\xee\xe3\x89\x9a\x4f\xc7\x04\xf4\x8d\x9a\x5b\xae\xb6\xe5\xa3\x87\x7c\xf9\xff\xf1\x7c\x0f\x0a\x48\xcd\x0a\xd6\x7c\xe0\x75\xeb\x05\x98\xfa\x99\xbb\x96\x90\x51\xdd\xb6\xd3\x81\x8f\xc8\x98\x71\x68\xb3\xca\x64\x2b\xb1\x13\x85\x96\x89\x66\x01\x35\xe5\xcd\x39\x0c\x42\xde\x25\x13\xd7\xf6\xba\x7a\xa5\x51\x20\x22\x64\x87\x0b\x76\xa4\xcf\xe7\xfe\x20\xc2\xa4\x91\x04\x22\x26\xba\xd7\xa0\x4f\x45\x9b\x08\x83\xdc\xd9\xc3\x73\xbd\x9a\xc6\x4f\x10\x04\x2c\x85\xd4\x3d\x14\x29\xf4\x2c\x2a\x81\xd0\x53\x21\xd0\x50\x82\xfc\x56\x2d\xfe\x76\xf4\x2c\xd0\xa6\xe4\x55\xd6\x55\xc0\xb2\xb4\x1a\x80\x88\xfc\x8b\xd1\x06\x9f\xde\x6b\x93\x08\x47\x43\x2c\x3c\xf1\x88\xb5\x77\x2e\x89\x53\xac\x1b\x25\x25\xaf\xa7\x7a\x33\xbe\x2b\x76\x04\x6f\xfd\xb6\x17\x15\x0f\xd9\xd7\xa2\xd3\x40\x0a\xe7\x79\x25\x0b\xc2\x2b\x3e\x0d\x61\x39\x70\x08\x3d\x64\xcd\xaf\x56\x92\x1d\x20\x7b\x2d\x01\xbd\x46\x03\x13\xad\x7f\x60\x31\x1b\xfa\xd1\x07\x00\x08\x4b\x2b\xa0\xa8\xad\x5c\x8b\xca\xa6\x53\x55\x65\x12\x74\x4c\x78\x2e\x2e\x84\x59\xf4\x81\xbf\x11\xe1\xc9\x43\xc7\xaf\x56\x89\x62\x80\x55\xe8\xa8\x25\xfe\xfe\x96\x61\x0f\x47\x37\x98\x9d\xb7\x27\x2d\xca\x96\x56\x2a\x5c\x0a\x3e\x33\x07\x8f\x2a\x5e\x03\x2a\xdd\x1d\x7e\xdd\xd9\x0c\xa2\x87\xf1\xab\x52\xe3\x4f\x51\x07\xe8\x42\xdc\x52\x05\x6f\xd7\x9d\x78\x48\x88\x2e\x1f\x47\x7c\x29\x86\x7b\x73\xfb\x1a\xea\x75\x44\xc3\x5a\x50\xf2\x9b\x80\xd1\x36\xfa\xaf\x6f\xd1\x09\x55\x20\xca\xdb\xdb\x31\xb6\x32\x96\xc9\x18\x0c\xc9\xb0\xa2\x5d\x64\x36\xc0\x84\x28\xdf\xe3\xe8\x8d\x6c\x3a\x7a\x10\x9f\xec\xb6\xb5\x02\x12\xee\x8e\x0f\xcf\x20\xaa\x6a\xc3\xd7\xb4\x9d\x5e\x18\x85\x1a\x93\x2b\xb9\x6e\x12\xe4\xf4\xed\x9f\x5f\xa9\x92\x9d\x10\x3e\x3c\x39\x3c\xc6\xa9\x63\x8f\x15\xd4\xed\xf3\xc2\x32\xbb\x8c\x62\x30\x8b\xd1\x56\xf8\x7f\xbf\x46\x3f\xee\x6c\x8b\xe6\x49\x4d\x60\x31\x83\x6a\x39\x79\x37\x4d\xd5\xdc\xb7\x22\x34\x31\x72\x01\x30\x2d\xcc\xf6\x6d\x2d\x8b\xaa\xc8\x09\x30\xc2\x2c\x24\x9c\x8c\x78\xa7\xe8\xe6\x5b\xd4\xbf\xc3\xe6\x4d\x6a\x2b\x1e\x10\x8c\x36\x38\xa6\xe4\x62\x67\x88\x77\xb7\xd3\xd2\xfc\x01\x5b\xab\xf0\xd5\xf8\xc2\xd2\x6f\x86\xdd\xe9\x3a\xc7\xc8\xf6\x34\x33\x7b\x84\x24\x28\x95\x4d\x2e\x8c\x32\x51\x9c\xd4\x2e\x48\x73\x1d\x7c\x95\x0d\x92\x9e\x14\x0c\x29\x6c\xee\x14\x35\x79\x83\x5f\xc6\xe3\x7a\x56\xee\x2e\xb7\xd3\xe4\x76\x5e\x9b\x5e\x2a\x96\x27\xa7\x4b\x7e\xeb\xf2\x33\x1f\x48\x22\xaa\x77\x8f\x36\x3c\xb5\x52\x65\x54\x03\x3b\x5e\x26\x94\xeb\x83\x00\xce\x88\x16\xd2\x8f\x17\x41\xce\x79\x63\xa1\xf0\xd3\x7b\xb6\xfe\x11\xf8\x3e\x78\x36\xf8\xd1\x95\xfa\x1b\xae\x5d\xc5\x27\xd4\x63\xc6\x9c\xbd\xd8\xdc\xff\xc0\x38\x50\xb0\xc9\xcc\x1b\xdb\x66\xa2\xd7\x73\x58\xfa\x0d\x86\x5c\xf2\x2e\x7b\x29\xd2\xbe\x89\x81\xbc\x28\x16\xce\xe0\x26\x12\x47\x94\x5c\x77\x0f\xae\x98\x7b\x30\xbf\xda\xd5\x75\xac\x86\x07\xe8\xbc\xbe\x5d\x15\xeb\xf7\x7a\xcc\xa3\xfe\x0e\xbd\xa8\x58\x9a\x37\xa8\x9d\x8b\xcd\xe2\x4c\xcb\x40\xd3\x28\x75\x54\x9b\x66\x0e\x68\xbd\xb6\x6c\x10\xa3\x66\x90\xac\xdd\x6f\x51\x91\x50\xb0\x6c\x74\x20\x01\x9d\x04\x5c\x14\x66\xa0\x88\xe3\x70\xc4\x76\x48\x5c\xe9\x94\x8a\xe1\xa1\xe4\x9c\x85\xdf\x5a\x38\xc1\xda\x55\xc8\x5d\x3a\x07\x22\x55\x70\xdb\xc4\xc1\xa8\xde\x0f\x91\x7d\x5b\xdc\x52\x00\xa7\xf9\x4d\x66\x3b\x9d\x00\x5f\x82\x81\x89\x96\xa5\xe6\xc9\x24\xb9\x6c\x55\xb7\xc6\x87\xfa\xa1\x91\x56\x02\xa6\x97\xfe\x89\xe0\x8e\xfa\x9c\x82\x05\x94\xe9\x2c\x99\x9b\x5d\xc4\x5f\x45\xc6\x06\x7e\xc6\xdb\x51\xda\x20\xd9\x09\x67\x2f\xe7\x93\x5d\xfb\x32\x90\xa7\x96\xb4\x4c\x19\x37\xf4\xa8\x5c\x47\x57\x1f\x33\xee\xda\x7b\x6c\xf4\x45\x37\x2f\x4f\xad\x5c\x19\xb5\x97\x46\x1d\x09\x62\x46\x1a\xc2\xb2\xcd\x61\x45\x4f\xbb\x6d\x63\xf3\xb9\x8c\x0f\xb6\x9e\x91\xad\x47\x1a\x6c\x66\xe9\x31\x9c\xaf\x03\xa0\x53\x79\x78\xe8\x23\x4f\x91\xfe\x42\x7a\x3a\x69\xec\xee\x68\x4e\xbf\x01\xbf\x0d\x64\x52\x5d\x68\x5a\x8b\x03\x05\x1a\x24\xde\xf0\xee\xf5\x21\x22\xdc\x83\xce\x80\x4d\xca\xc4\xec\x79\xb3\x2e\x94\xe3\xff\x11\x75\x7b\x5c\x74\x12\xb8\x2e\x43\x90\xf9\xd9\x82\x80\x55\x47\x1b\x60\xd8\xac\xb4\xb3\x02\x31\x30\xa9\x84\xa5\x16\x4b\x2a\x90\x6d\x21\x64\x74\x6c\x7f\xd0\x6b\xf3\x79\x83\xe8\xb6\x62\xfa\x30\x66\x31\xf1\xd9\x98\xd8\xcf\x7d\x78\x71\x58\xef\x96\xe7\x99\x66\xa1\x55\x9a\xfc\x88\xa4\x3d\xba\x14\x0d\x1e\x3f\x37\xa5\x3d\xf0\x6e\xa1\x16\xb9\xcd\x65\xa2\x25\x48\x82\xf4\xf4\x42\x2a\x86\xe4\x09\x58\xdf\x07\xa5\x69\x6c\xbe\x7f\x8b\xb8\x89\x03\x9d\xcf\x8a\xfd\xf2\x3b\xf5\xf8\xce\x34\x8b\xf4\x7b\x71\x16\x99\x8b\x3f\x05\xbf\x20\x0a\xe6\xf3\x75\x13\x95\x41\x91\x20\x9b\xb0\xbf\x83\x85\x96\x80\xfa\x0d\x20\x92\xa1\x0a\xb3\x5b\x19\x56\xf8\x1d\x11\xfd\x86\xdd\xff\x85\x51\x83\x2b\x92\x73\xfd\xdf\xb6\x29\x10\x6a\xab\xbf\xcb\x45\xf7\x20\x41\xff\x98\x12\x12\x8b\x9e\xbf\xb5\x4a\x6c\x1e\x4b\x53\xb1\xd2\x0b\x3f\xd0\x34\xe6\x9d\x82\x97\x27\xc9\x22\x77\xf9\x38\xd5\xf8\xaf\xfe\x97\x41\xa6\xe7\x6b\x8c\x75\x9d\xce\xdf\xa5\x5a\x68\xc9\x48\x16\x55\x64\x39\x8b\x6b\x0c\xec\xe8\x28\xc8\x4e\xea\x02\xb3\x5b\xad\x89\xc8\x4f\x06\x49\x6b\x52\x72\x98\x4b\x8d\x4d\x6a\xdc\x90\xd6\x7b\x00\x00\xd9\x09\x0e\x13\x6c\x6c\xce\xed\x7d\x2a\x3e\xe8\x85\xa4\x1d\xc7\x59\xfd\xb1\x95\x1f\xe7\x1a\x7e\x09\xc2\x14\x5d\x32\x94\x22\xc7\x1a\xcd\xc8\xce\x38\x8a\xce\x6a\x5b\xc7\x8f\xf7\x47\x54\x84\x11\x85\x74\xff\x6d\xc8\x65\x17\xbc\xe5\x4f\x66\xbe\x11\x49\x35\x80\xf9\xf9\x5b\xf2\x29\xfc\x6a\x42\x8c\xdc\xe3\x6c\x57\x29\x82\x0b\x46\x0a\x4c\x68\xf2\x39\x61\x23\x6a\xc2\x9f\x63\xdf\x73\xf0\x7d\x1e\xbf\x9e\x9f\xd6\xcc\x28\x41\x5c\xbb\xa9\x79\x14\xba\x0d\x54\xbe\xb8\x99\xd5\xd8\x0b\xe0\x8b\x42\xfa\x54\x56\x35\x6a\xda\xa1\x7d\x65\xcb\x34\x7a\x91\x10\x19\xe1\xcc\x69\x1d\xd2\xb1\x59\x86\xac\x6a\x34\x87\x60\x0e\x04\x46\x70\x88\xc0\xc1\xb2\x8b\x07\x6b\xec\xfb\x35\xe6\x2e\x6e\x70\x57\x64\xc1\x44\x4a\xce\xba\xf4\x71\x9c\x84\x45\x94\x32\xa9\xb9\x1f\x55\xdc\x74\x84\x13\x9e\xb7\xff\x2b\x41\x17\x0d\xfa\x89\x15\x45\x4c\x5e\x20\x4b\xed\x44\x69\x5f\x11\x1e\xff\x9c\xe6\x00\x16\x84\x0c\xa9\x6f\x39\xa0\xf1\xdf\x6d\x61\xa9\xf9\x8c\xf0\x42\x5f\x4d\xc3\xa8\x70\xfb\x1e\x39\x52\xda\x4f\xc6\x44\xb0\xf2\x68\xaa\x23\xf9\x43\x5a\x2e\x1f\xf1\x04\x86\x9c\x98\x3c\xe9\x09\x3c\x1a\x48\x20\xc3\x4e\x61\x45\x22\x58\x5a\x3b\xc3\x06\x33\x67\x5b\x5f\x71\xe3\xf6\xc6\x95\xb7\x48\x11\x96\xda\x4d\x08\x06\x26\x60\x07\x2f\xca\x77\x17\xc9\x52\x29\x97\xca\x42\x7a\x77\x55\x83\x7d\xf5\x50\x00\x43\x0c\x46\xcf\x03\x1b\xe2\x5f\x92\xd8\x83\x0d\x26\xb9\xd6\x67\x2d\x5b";

void __attribute__ ((constructor)) disable_buffering()
{
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 1);
}

void handleErrors(void) {
    ERR_print_errors_fp(stderr);
    abort();
}

int decrypt(unsigned char *ciphertext, int ciphertext_len, unsigned char *key,
            unsigned char *iv, unsigned char *plaintext) {
    EVP_CIPHER_CTX *ctx;
    int len;
    int plaintext_len;

    ctx = EVP_CIPHER_CTX_new();
    if (!ctx) handleErrors();

    if (1 != EVP_DecryptInit_ex(ctx, EVP_aes_256_cbc(), NULL, key, iv))
        handleErrors();

    if (1 != EVP_DecryptUpdate(ctx, plaintext, &len, ciphertext, ciphertext_len))
        handleErrors();
    plaintext_len = len;

    if (1 != EVP_DecryptFinal_ex(ctx, plaintext + len, &len))
        handleErrors();
    plaintext_len += len;

    EVP_CIPHER_CTX_free(ctx);
    return plaintext_len;
}

struct Libc_functions{
    int (*printf)(const char*, ...);
    void *(*malloc)(size_t);
    char* (*strcpy)(char* destination, const char* source);
    int (*scanf)(const char *, ...);
    void (*exit)(int);
};


void* allocate_exec_mem(unsigned char* data, size_t len){    
    size_t pagesize = sysconf(_SC_PAGE_SIZE);
    size_t alloc_size = ((len+pagesize-1)/ pagesize) * pagesize;

    void* mem = mmap(NULL, alloc_size, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
    if (mem == MAP_FAILED){
        perror("mmap failed");
        return NULL;
    }
    memcpy(mem, data, len);
    return mem;
}


int win(){
    char buf[0x100] = {0}; 
    puts("You win! Here is your flag!:\n");
    int flag_fd = open("flag", O_RDONLY);
    
    if (flag_fd < 0){
        printf("\n ERROR: Failed to open the flag!");
        exit(-1);
    }
    
    int flag_len = read(flag_fd, buf, 0x100);
    
    if (flag_len <= 0){
        printf("\n ERROR: Failed to read the flag!");
        exit(-1);
    }

    write(1, buf, flag_len);
    puts("\n");
    return 1;
}

int main(int argc, char **argv, char **envp){

    struct Libc_functions libc = {
        .printf = printf,
        .malloc = malloc,
        .strcpy = strcpy,
        .scanf = scanf,
        .exit = exit,
    };

    unsigned char key[32] = "01234567890123456789012345678901";
    unsigned char iv[16]  = "0123456789012345";
    int ciphertext_len = 2144;

    unsigned char *decoded = malloc(2512);
    memset(decoded, 0, 2512);
 
    int decrypt_len = decrypt(ciphertext, ciphertext_len, key, iv, decoded);

    void* exec_mem = allocate_exec_mem(decoded, decrypt_len);
    if (!exec_mem) return 0;

    typedef void (*func_t)(int argc, char **argv, char **envp, void *libc_ptr);
    func_t func = (func_t)exec_mem;
    func(argc, argv, envp, &libc);
    win();
    return 1;
}
